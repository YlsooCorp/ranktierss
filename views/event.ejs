<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= event.name %> | Bracket</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header class="navbar">
    <h1 class="logo"><a href="/">RankTiers</a></h1>
    <nav>
      <a href="/events" class="active-nav">Events</a>
      <a href="/submit">Submit Stats</a>
      <% if (admin) { %>
        <a href="/admin/dashboard">Admin</a>
      <% } %>
      <% if (user) { %>
        <a href="/account">Account</a>
        <a href="/logout" class="logout">Logout</a>
      <% } else { %>
        <a href="/login">Login</a>
        <a href="/register">Register</a>
      <% } %>
    </nav>
  </header>

  <main class="event-page">
    <section class="page-header">
      <div class="page-header-actions">
        <a class="back-link" href="/events">← Back to events</a>
        <% if (adminView) { %>
          <a class="back-link" href="/admin/dashboard">Admin dashboard</a>
        <% } %>
      </div>
      <h2><%= event.name %></h2>
      <p class="event-meta">Game: <strong><%= event.game %></strong> • Kit: <strong><%= event.kit %></strong></p>
      <p class="event-meta">Tiers: <%= (event.tiers || []).join(", ") %></p>
    </section>

    <% if (adminMessage) { %>
      <div class="notice success"><%= adminMessage %></div>
    <% } %>
    <% if (adminError) { %>
      <div class="notice error"><%= adminError %></div>
    <% } %>

    <section class="bracket-section">
      <h3>Bracket</h3>
      <% if (bracket.rounds && bracket.rounds.length > 0) { %>
        <div class="bracket-grid">
          <% bracket.rounds.forEach((round, index) => { %>
            <div class="bracket-round">
              <h4>Round <%= index + 1 %></h4>
              <% round.forEach(match => { %>
                <div class="bracket-match <%= match.winner ? 'match-complete' : '' %>">
                  <div class="match-player <%= match.winner && match.player1 && match.winner.id === match.player1.id ? 'is-winner' : '' %>">
                    <span><%= match.player1 ? match.player1.username : 'TBD' %></span>
                  </div>
                  <div class="match-player <%= match.winner && match.player2 && match.winner.id === match.player2.id ? 'is-winner' : '' %>">
                    <span><%= match.player2 ? match.player2.username : 'TBD' %></span>
                  </div>
                  <% if (adminView && !match.autoAdvance && !match.winner && match.player1 && match.player2) { %>
                    <form class="match-form" method="POST" action="/admin/events/<%= event.id %>/report">
                      <input type="hidden" name="matchId" value="<%= match.id %>">
                      <label class="sr-only" for="winner-<%= match.id %>">Winner</label>
                      <select id="winner-<%= match.id %>" name="winnerId" required>
                        <option value="">Select winner</option>
                        <option value="<%= match.player1.id %>"><%= match.player1.username %></option>
                        <option value="<%= match.player2.id %>"><%= match.player2.username %></option>
                      </select>
                      <button type="submit">Record</button>
                    </form>
                  <% } else { %>
                    <p class="match-status">
                      <% if (match.winner) { %>
                        Winner: <strong><%= match.winner.username %></strong>
                      <% } else if (match.autoAdvance) { %>
                        Advanced by bye
                      <% } else { %>
                        Awaiting result
                      <% } %>
                    </p>
                  <% } %>
                </div>
              <% }) %>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <div class="empty-state card">
          <h4>Bracket unavailable</h4>
          <p>This event does not have a bracket yet.</p>
        </div>
      <% } %>
    </section>

    <section class="event-records">
      <h3>Participant Records</h3>
      <% if (records.length > 0) { %>
        <table>
          <thead>
            <tr>
              <th>Player</th>
              <th>Wins</th>
              <th>Losses</th>
            </tr>
          </thead>
          <tbody>
            <% records.forEach(record => { %>
              <tr>
                <td><%= record.players ? record.players.username : record.player_id %></td>
                <td><%= record.wins || 0 %></td>
                <td><%= record.losses || 0 %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p class="empty">No results recorded yet.</p>
      <% } %>
    </section>
  </main>

  <footer>
    <p>© 2025 RankTiers. All rights reserved.</p>
    <nav>
      <a href="/terms">Terms of Service</a>
      <span aria-hidden="true">•</span>
      <a href="/privacy">Privacy Policy</a>
      <span aria-hidden="true">•</span>
      <a href="/discord" target="_blank" rel="noopener">Join our Discord</a>
    </nav>
  </footer>
</body>
</html>
