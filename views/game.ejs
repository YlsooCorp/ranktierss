<!DOCTYPE html>
<html lang="en">
  <%- include('partials/head', { pageTitle }) %>
  <body class="mc-body">
    <div class="mc-background"></div>
    <%- include('partials/navbar', { navActive: typeof navActive !== 'undefined' ? navActive : null }) %>

    <main class="mc-main">
      <section class="mc-page-header">
        <div class="mc-container mc-page-header__grid">
          <div>
            <p class="mc-tag">Minecraft Leaderboard</p>
            <h1 class="mc-heading"><%= gameName %> Rankings</h1>
            <p class="mc-text-muted">Live points and tiers for every verified Minecraft competitor.</p>
          </div>
          <form id="playerSearchForm" class="mc-search" autocomplete="off">
            <label class="sr-only" for="playerSearchInput">Search player</label>
            <input
              id="playerSearchInput"
              class="mc-input"
              type="text"
              name="player"
              placeholder="Search player by IGN"
              required
            />
            <button class="mc-button mc-button--accent" type="submit">View Profile</button>
          </form>
        </div>
      </section>

      <section class="mc-section">
        <div class="mc-container">
          <% const kitNames = Array.from(
              new Set((stats || []).flatMap(entry => (entry.kits || []).map(kit => kit.kit)))
            ).slice(0, 14); %>

          <% if (kitNames.length > 0) { %>
            <div class="mc-kit-strip">
              <span class="mc-kit-strip__label">Kits</span>
              <% kitNames.forEach(name => { %>
                <span class="mc-kit-chip"><%= name %></span>
              <% }) %>
            </div>
          <% } %>

          <% if (!stats || stats.length === 0) { %>
            <div class="mc-empty mc-card">
              <h2>No placements yet</h2>
              <p>Be the first to submit a verified result for this ladder.</p>
              <a class="mc-button mc-button--accent" href="/submit">Submit Proof</a>
            </div>
          <% } else { %>
            <div class="mc-card mc-card--table mc-leaderboard">
              <table class="mc-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Player</th>
                    <th>Loadout</th>
                    <th>Total Points</th>
                  </tr>
                </thead>
                <tbody>
                  <% stats.forEach((stat, index) => {
                       const isLinked = (userLinked || []).some(account => account.game_username === stat.players?.username);
                       const rank = index + 1;
                       const rowClasses = [
                         isLinked ? 'is-highlighted' : '',
                         rank <= 3 ? `is-top-${rank}` : ''
                       ].filter(Boolean).join(' ');
                  %>
                    <tr class="<%= rowClasses %>">
                      <td data-title="Rank">#<%= rank %></td>
                      <td data-title="Player" class="mc-player">
                        <a href="/profile/<%= stat.players?.username %>" class="mc-player__link">
                          <img
                            src="https://minotar.net/avatar/<%= stat.players?.username %>/32.png"
                            alt="<%= stat.players?.username %> skin"
                            class="mc-player__avatar"
                            loading="lazy"
                          />
                          <span><%= stat.players?.username %></span>
                        </a>
                        <% if (isLinked) { %>
                          <span class="mc-badge">You</span>
                        <% } %>
                      </td>
                      <td data-title="Loadout" class="mc-kits">
                        <% if (stat.kits && stat.kits.length > 0) { %>
                          <ul>
                            <% stat.kits.forEach(kit => { %>
                              <li>
                                <span class="mc-kit-name"><%= kit.kit %></span>
                                <span class="mc-kit-tier"><%= kit.tier %></span>
                              </li>
                            <% }) %>
                          </ul>
                        <% } else { %>
                          <span class="mc-text-muted">No kits recorded</span>
                        <% } %>
                      </td>
                      <td data-title="Points"><span class="mc-point-chip"><%= stat.total_points %></span></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      </section>
    </main>

    <%- include('partials/footer') %>

    <script>
      const searchForm = document.getElementById('playerSearchForm');
      const searchInput = document.getElementById('playerSearchInput');
      searchForm?.addEventListener('submit', event => {
        event.preventDefault();
        const value = searchInput?.value.trim();
        if (!value) return;
        window.location.href = `/profile/${encodeURIComponent(value)}`;
      });
    </script>
  </body>
</html>
